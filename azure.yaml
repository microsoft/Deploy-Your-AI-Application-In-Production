name: deploy-your-ai-application-in-production

requiredVersions:
  azd: ">=1.15.0"

infra:
  provider: "bicep"
  path: "infra"
  module: "main-orchestrator"
  parameters: "main-orchestrator.bicepparam"

metadata:
  template: deploy-your-ai-application-in-production@1.0

# Post-provision automation hooks
# These scripts run automatically after infrastructure deployment
hooks:
  postprovision:
    # Clean up any stale environment files
    - run: ./scripts/automationScripts/00_cleanup_environment.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 1: Fabric Capacity Validation
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/ensure_active_capacity.ps1
      interactive: false
      shell: pwsh
      continueOnError: false
    
    # Stage 2: Fabric Domain Creation
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/create_fabric_domain.ps1
      interactive: false
      shell: pwsh
      continueOnError: false
    
    # Stage 3: Fabric Workspace Creation
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/create_fabric_workspace.ps1
      interactive: false
      shell: pwsh
      continueOnError: false
    
    # Stage 4: Assign Workspace to Domain
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/assign_workspace_to_domain.ps1
      interactive: false
      shell: pwsh
      continueOnError: false
    
    # Stage 5: Purview Collection Creation
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/create_purview_collection.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 6: Register Fabric as Purview Data Source
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/register_fabric_datasource.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 7: Create Lakehouses (bronze, silver, gold)
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/create_lakehouses.ps1
      interactive: false
      shell: pwsh
      continueOnError: false
    
    # Stage 8: Setup Fabric Workspace Private Link (for VNet integration)
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/setup_fabric_private_link.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 9: Materialize Document Folders in Bronze Lakehouse
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/materialize_document_folders.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 10: OneLake Indexing - Setup RBAC
    - run: ./scripts/automationScripts/OneLakeIndex/01_setup_rbac.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 11: OneLake Indexing - Create Skillsets
    - run: ./scripts/automationScripts/OneLakeIndex/02_create_onelake_skillsets.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 12: OneLake Indexing - Create Index
    - run: ./scripts/automationScripts/OneLakeIndex/03_create_onelake_index.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 13: OneLake Indexing - Create Data Source
    - run: ./scripts/automationScripts/OneLakeIndex/04_create_onelake_datasource.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 14: OneLake Indexing - Create Indexer
    - run: ./scripts/automationScripts/OneLakeIndex/05_create_onelake_indexer.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 15: AI Foundry Search RBAC Setup
    - run: ./scripts/automationScripts/OneLakeIndex/06_setup_ai_foundry_search_rbac.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 16: Trigger Purview Scan (if Purview enabled)
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/trigger_purview_scan_for_fabric_workspace.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 17: Connect Log Analytics (placeholder)
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/connect_log_analytics.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
