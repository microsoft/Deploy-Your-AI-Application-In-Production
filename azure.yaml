name: deploy-your-ai-application-in-production

requiredVersions:
  azd: ">=1.15.0"

infra:
  provider: "bicep"
  path: "submodules/ai-landing-zone/bicep/infra"
  module: "main"
  parameters: "../../../../infra/main.bicepparam"

metadata:
  template: deploy-your-ai-application-in-production@1.0

# Pre/Post-provision automation hooks
hooks:
  preprovision:
    - shell: sh
      run: ./submodules/ai-landing-zone/bicep/scripts/preprovision.sh
      interactive: true
      continueOnError: false
  
  postprovision:
    # Clean up any stale environment files
    - run: ./scripts/automationScripts/00_cleanup_environment.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 0: Deploy Fabric Capacity (extends AI Landing Zone)
    - run: ./scripts/postprovision/deploy_fabric_capacity.sh
      interactive: false
      shell: sh
      continueOnError: false
    
    # Stage 1: Fabric Capacity Validation
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/ensure_active_capacity.ps1
      interactive: false
      shell: pwsh
      continueOnError: false
    
    # Stage 2: Fabric Domain Creation
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/create_fabric_domain.ps1
      interactive: false
      shell: pwsh
      continueOnError: false
    
    # Stage 3: Fabric Workspace Creation
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/create_fabric_workspace.ps1
      interactive: false
      shell: pwsh
      continueOnError: false
    
    # Stage 3.3: Create Private Link Service Resource (prerequisite for private endpoint)
    - run: ./scripts/postprovision/create_fabric_private_link_service.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 3.5: Enable Workspace Inbound Protection Policy
    - run: ./scripts/automationScripts/FabricWorkspace/enable_fabric_workspace_inbound_protection.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 3.7: Setup Workspace Private Endpoint (for secure VNet access)
    - run: ./scripts/postprovision/setup_workspace_private_endpoint.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 4: Assign Workspace to Domain
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/assign_workspace_to_domain.ps1
      interactive: false
      shell: pwsh
      continueOnError: false
    
    # Stage 5: Purview Collection Creation
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/create_purview_collection.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 6: Register Fabric as Purview Data Source
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/register_fabric_datasource.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 7: Create Lakehouses (bronze, silver, gold)
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/create_lakehouses.ps1
      interactive: false
      shell: pwsh
      continueOnError: false
    
    # Stage 8: Setup Fabric Workspace Private Link (for VNet integration)
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/setup_fabric_private_link.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 9: Materialize Document Folders in Bronze Lakehouse
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/materialize_document_folders.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 10: OneLake Indexing - Setup RBAC
    - run: ./scripts/automationScripts/OneLakeIndex/01_setup_rbac.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 11: OneLake Indexing - Create Skillsets
    - run: ./scripts/automationScripts/OneLakeIndex/02_create_onelake_skillsets.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 12: OneLake Indexing - Create Index
    - run: ./scripts/automationScripts/OneLakeIndex/03_create_onelake_index.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 13: OneLake Indexing - Create Data Source
    - run: ./scripts/automationScripts/OneLakeIndex/04_create_onelake_datasource.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 14: OneLake Indexing - Create Indexer
    - run: ./scripts/automationScripts/OneLakeIndex/05_create_onelake_indexer.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 15: AI Foundry Search RBAC Setup
    - run: ./scripts/automationScripts/OneLakeIndex/06_setup_ai_foundry_search_rbac.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 16: Trigger Purview Scan (if Purview enabled)
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/trigger_purview_scan_for_fabric_workspace.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
    
    # Stage 17: Connect Log Analytics (placeholder)
    - run: ./scripts/automationScripts/Fabric_Purview_Automation/connect_log_analytics.ps1
      interactive: false
      shell: pwsh
      continueOnError: true
